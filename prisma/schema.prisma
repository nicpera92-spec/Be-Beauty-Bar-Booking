generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Service {
  id            String   @id @default(cuid())
  name          String
  category      String   // nails | lash | permanent-makeup
  position      Int      @default(0) // admin-defined order (lower = first)
  durationMin   Int      // minutes allotted per booking
  price         Float    @default(0) // full price; deposit is deducted from this
  depositAmount Float    // required to confirm; must be <= price
  description   String?  @default("")
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  addOns        AddOn[]
  bookings      Booking[]
}

model AddOn {
  id        String   @id @default(cuid())
  serviceId String
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  name      String   // e.g. "French"
  price     Float    // e.g. 10 (£)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BusinessSettings {
  id                   String   @id // single row, use "default"
  businessName         String   @default("Be Beauty Bar")
  businessEmail        String?  // for confirmation emails to owner
  adminLoginEmail      String?  // admin login email
  adminPasswordHash    String?  // bcrypt hash of admin password
  instagramHandle      String?  // e.g. bebeautybar — for "DM on Instagram" note
  defaultDepositAmount Float?   // optional default when adding new services (£)
  defaultPrice         Float?   // optional default full price for new services (£)
  openTime             String   @default("09:00")  // HH:mm, 15-min steps e.g. 09:15
  closeTime            String   @default("17:00")  // HH:mm, 15-min steps e.g. 21:45
  slotInterval         Int      @default(30)  // minutes between slots (5, 15, 30, etc.)
  primaryColor         String?  @default("#1e3a5f") // main accent color (hex)
  secondaryColor       String?  @default("#2c5282") // secondary accent color (hex)
  stripeSecretKey      String?  // Stripe secret key (starts with sk_test_ or sk_live_)
  stripeWebhookSecret  String?  // Stripe webhook signing secret (starts with whsec_)
  smsNotificationFee   Float?   @default(0.05) // Fee per booking for SMS notifications (£)
  updatedAt            DateTime @updatedAt
}

model AvailabilityBlock {
  id        String   @id @default(cuid())
  startDate String   // yyyy-MM-dd
  startTime String   // HH:mm, hour granularity
  endDate   String   // yyyy-MM-dd
  endTime   String   // HH:mm, hour granularity
  createdAt DateTime @default(now())
}

model BookingAddOn {
  id          String  @id @default(cuid())
  bookingId   String
  booking     Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  addOnId     String
  addOnName   String  // snapshot at booking time
  addOnPrice  Float   // snapshot at booking time
}

model Booking {
  id                String         @id @default(cuid())
  serviceId         String
  service           Service        @relation(fields: [serviceId], references: [id])
  bookingAddOns     BookingAddOn[]
  customerName      String
  customerEmail     String?  // optional, but at least one of email/phone required
  customerPhone     String?  // optional, but at least one of email/phone required
  date              String   // YYYY-MM-DD
  startTime         String   // HH:mm
  endTime           String   // HH:mm
  servicePrice      Float    // full price at booking time
  depositAmount     Float    // required to confirm
  balancePaidOnline Boolean  @default(false) // true if remaining paid via Stripe
  status            String   @default("pending_deposit") // pending_deposit | confirmed | cancelled
  notes             String?  @default("")
  notifyByEmail     Boolean  @default(true) // customer wants email notifications
  notifyBySMS       Boolean  @default(false) // customer wants SMS notifications
  stripeDepositPaymentIntentId  String?   // for refunds
  stripeBalancePaymentIntentId  String?
  depositRefundedAt DateTime?
  balanceRefundedAt DateTime?
  reminderSentAt    DateTime?  // 24h reminder sent
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}
